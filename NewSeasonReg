// FILE: New Season Registration Page (vc73t.js) – 2026 Flow
import wixData from 'wix-data';
import wixUsers from 'wix-users';
import wixLocation from 'wix-location';
import { getDivisionNote } from 'backend/airtable';
import { session } from 'wix-storage';
import { clearCurrentCart } from 'backend/cartManager';
import { COLLECTIONS, DIVISIONS, SPORTS, SEASON, FORM_OPTIONS, ROUTES, DELAYS } from 'public/constants.js';


const REGISTRATION_COLLECTION = COLLECTIONS.REGISTRATION;
const PLAYER_COLLECTION = COLLECTIONS.PLAYER;

let selectedPlayerId = null;
let playerBirthDate = null;
let playerDataMap = {};

// ===== HELPER FUNCTIONS =====
function safeShow(id, text = "") {
    try {
        const el = $w(id);
        if (!el) return;
        if (text && el.text !== undefined) el.text = text;
        el.show();
    } catch (e) {
        console.warn(`[safeShow] Failed to show element ${id}:`, e.message);
    }
}

function safeHide(id) {
    try {
        $w(id)?.hide();
    } catch (e) {
        console.warn(`[safeHide] Failed to hide element ${id}:`, e.message);
    }
}

function safeCollapse(id) {
    try {
        $w(id)?.collapse();
    } catch (e) {
        console.warn(`[safeCollapse] Failed to collapse element ${id}:`, e.message);
    }
}

function safeExpand(id) {
    try {
        $w(id)?.expand();
    } catch (e) {
        console.warn(`[safeExpand] Failed to expand element ${id}:`, e.message);
    }
}

// ===== FORM VALIDATION =====
function isFormValid() {
    const requiredIds = [
        "#inputSchool", "#dropdownJerseySize", "#inputEmergencyName", 
        "#inputEmergencyPhone", "#teamParent", "#coachVolunteer"
    ];
    const checkboxes = ["#checkbox2", "#checkbox3", "#checkbox4"];
    const playDown = $w("#PlayDown");
    const otherSchool = $w("#inputSchoolother");

    let valid = true;

    requiredIds.forEach(id => {
        try {
            const el = $w(id);
            if (el?.isVisible && !el.valid) valid = false;
        } catch (e) {}
    });

    checkboxes.forEach(id => {
        if (!$w(id).checked) valid = false;
    });

    if (playDown?.isVisible && !playDown.value) valid = false;
    if (otherSchool?.isVisible && !otherSchool.value?.trim()) valid = false;

    return valid;
}

// ===== SCHOOL "OTHER" LOGIC =====
function handleSchoolOther() {
    const school = $w("#inputSchool").value;
    const other = $w("#inputSchoolother");

    if (school === FORM_OPTIONS.SCHOOL_OTHER) {
        safeExpand("#inputSchoolother");
        other.required = true;
    } else {
        safeCollapse("#inputSchoolother");
        other.value = "";
        other.required = false;
    }
    $w("#buttonRegister").disabled = !isFormValid();
}

// ===== VOLUNTEER FIELDS VISIBILITY =====
function updateVolunteerFields() {
    const teamParent = ($w("#teamParent").value || "").includes("Yes");
    const coach = ($w("#coachVolunteer").value || "").includes("Yes");
    const anyVolunteer = teamParent || coach;

    ["#inputParentVolunteerName", "#inputParentVolunteerEmail", "#inputParentVolunteerPhone"].forEach(id => {
        const el = $w(id);
        if (teamParent) { safeExpand(id); el.required = true; }
        else { safeCollapse(id); el.value = ""; el.required = false; }
    });

    ["#coachVolunteerType", "#volunteerCoachName", "#volunteerCoachEmail", "#volunteerCoachNumber"].forEach(id => {
        const el = $w(id);
        if (coach) { safeExpand(id); el.required = true; }
        else { safeCollapse(id); el.value = ""; el.required = false; }
    });

    // Show/hide additional volunteer fields when either volunteer option is selected
    ["#inputVolOtherLL", "#volunteerCoachPriorHistory", "#dropdownVolCrimesMinors",
     "#dropdownVolPriorCrime", "#dropdownVolPending", "#dropdownVolCriminalCharges",
     "#checkboxVolPrivacyPolicy", "#checkboxChildProtectionProgram", "#checkboxVolunteerApp"].forEach(id => {
        const el = $w(id);
        if (anyVolunteer) { safeExpand(id); }
        else { safeCollapse(id); el.value = ""; }
    });

    handleSchoolOther();
    $w("#buttonRegister").disabled = !isFormValid();
}

// ===== MAIN FORM VISIBILITY =====
function updateMainFormVisibility() {
    const ready = $w('#dropdownPlayer').value && $w('#dropdownSeason').value && $w('#dropdownSport').value;
    if (ready) {
        safeShow('#group2');
        safeShow('#group3');
        safeShow('#buttonRegister');
        updateVolunteerFields();
    } else {
        safeHide('#group2');
        safeHide('#group3');
        safeHide('#buttonRegister');
    }
}

// ===== DIVISION + FEE LOOKUP =====
async function loadDivisionAndFee(divisionKey) {
    safeShow('#noteText', "Loading division info...");
    safeHide('#textPlayDown');
    safeHide('#PlayDown');

    if (!divisionKey || divisionKey.includes("No ") || divisionKey.includes("Unknown")) {
        safeShow('#noteText', "Select valid player, sport, and season.");
        $w('#textFee').text = "";
        return;
    }

    try {
        const res = await getDivisionNote(divisionKey);
        if (res.success) {

            safeShow('#noteText', res.note || "");
            $w('#textFee').text = res.fee > 0 ? `$${res.fee.toFixed(2)}` : "FREE";

            // --- FIXED PLAY DOWN LOGIC ---
            if (res.playDownEligible) {
                safeExpand('#PlayDown');          // <-- important
                safeShow('#PlayDown');
                safeShow('#textPlayDown', "Eligible to request playing down");
            } else {
                safeHide('#PlayDown');
            }

            // --- Coach Request Logic ---
            if (res.coachRequestEligible) {
                safeExpand('#coachRequest');
                safeShow('#coachRequest');
            } else {
                safeHide('#coachRequest');
            }
        }
    } catch (e) {
        safeShow('#noteText', "Division info unavailable.");
    }
}


// ===== DUPLICATE CHECK FUNCTION =====
async function checkForDuplicates(playerId, seasonName, sport) {
    // Check 1: CMS SeasonRegistration collection (already paid registrations)
    try {
        const existing = await wixData.query(REGISTRATION_COLLECTION)
            .eq("player", playerId)
            .eq("seasonName", seasonName)
            .eq("sport", sport)
            .find();
        if (existing.items.length > 0) {
            return {
                isDuplicate: true,
                type: 'cms',
                message: "Player already registered for this season and sport in our records."
            };
        }
    } catch (e) {
        console.error("CMS duplicate check error:", e);
    }

    // Check 2: Session regQueue (pending registrations)
    try {
        const regQueue = JSON.parse(session.getItem("regQueue") || "[]");
        const duplicate = regQueue.find(r =>
            r.playerId === playerId &&
            r.seasonName === seasonName &&
            r.sport === sport
        );
        if (duplicate) {
            return {
                isDuplicate: true,
                type: 'queue',
                message: "Player already has a pending registration for this season and sport."
            };
        }
    } catch (e) {
        console.error("RegQueue duplicate check error:", e);
    }

    return { isDuplicate: false };
}

// ===== CLEAN DIVISION CALCULATION (2026 SEASON) =====
const calculateDivision = async () => {
    const playerOk = selectedPlayerId && playerBirthDate;
    const seasonOk = $w("#dropdownSeason").value;
    const sportOk = $w("#dropdownSport").value;

    if (!playerOk || !seasonOk || !sportOk) {
        $w("#textDivision").text = "Select player, season, and sport.";
        updateMainFormVisibility();
        return;
    }

    // Check for duplicates in both CMS and regQueue
    const duplicateCheck = await checkForDuplicates(selectedPlayerId, seasonOk, sportOk);
    if (duplicateCheck.isDuplicate) {
        // Show duplicate message in division note area
        safeShow('#noteText', duplicateCheck.message);
        $w("#textDivision").text = duplicateCheck.type === 'queue'
            ? "Player already in cart"
            : "Player already registered";
        $w('#textFee').text = "";

        // Hide form groups and buttons
        safeHide("#group2");
        safeHide("#group3");
        safeHide("#buttonRegister");
        safeHide('#textPlayDown');
        safeHide('#PlayDown');
        safeHide('#coachRequest');

        return;
    }

    // Clear any previous error messages
    safeHide("#textError");

    // calculate age
    const bd = new Date(playerBirthDate);
    const season = $w("#dropdownSeason").value;
    const year = season.match(/\d{4}/)?.[0] || "2026";
    const isFall = season.toLowerCase().includes("fall");

    // Get cutoff dates from constants based on sport
    const cutoffConfig = sportOk === SPORTS.BASEBALL
        ? SEASON.CUTOFF_DATES.BASEBALL
        : SEASON.CUTOFF_DATES.SOFTBALL;
    const cutoffMonth = cutoffConfig.month;
    const cutoffDay = cutoffConfig.day;

    const cutoffYear = isFall ? Number(year) + 1 : Number(year);
    const cutoffDate = new Date(cutoffYear, cutoffMonth, cutoffDay);
    const age = Math.floor((cutoffDate - bd) / (365.25 * 24 * 60 * 60 * 1000));

    const suffix = isFall ? SEASON.SUFFIX_FALL : SEASON.SUFFIX_SPRING;
    const seasonTag = ` - ${year}${suffix}`;

    let division = "Unknown";
    if (sportOk === SPORTS.BASEBALL) {
        if (age >= 14) division = DIVISIONS.BASEBALL_14U + seasonTag;
        else if (age === 13) division = DIVISIONS.BASEBALL_13U + seasonTag;
        else if (age >= 11 && age <= 12) division = DIVISIONS.BASEBALL_MAJORS + seasonTag;
        else if (age === 10) division = DIVISIONS.BASEBALL_UPPER_MINORS + seasonTag;
        else if (age === 9) division = DIVISIONS.BASEBALL_LOWER_MINORS + seasonTag;
        else if (age >= 7 && age <= 8) division = DIVISIONS.BASEBALL_COACH_PITCH + seasonTag;
        else if (age === 6) division = DIVISIONS.BASEBALL_PEEWEE_6 + seasonTag;
        else if (age >= 4 && age <= 5) division = DIVISIONS.BASEBALL_PEEWEE_4_5 + seasonTag;
    }
    else if (sportOk === SPORTS.SOFTBALL) {
        if (age >= 11 && age <= 12) division = DIVISIONS.SOFTBALL_MAJORS + seasonTag;
        else if (age >= 9 && age <= 10) division = DIVISIONS.SOFTBALL_MINORS + seasonTag;
        else if (age >= 7 && age <= 8) division = DIVISIONS.SOFTBALL_COACH_PITCH + seasonTag;
        else if (age >= 6 && age <= 7) division = DIVISIONS.SOFTBALL_DAISY + seasonTag;
    } else {
        division = "No division available";
    }

    $w("#textDivision").text = age >= 4 ? `Age ${age} → ${division}` : "Player too young/old";

    await loadDivisionAndFee(division);
    updateMainFormVisibility();
};

// ===== PAGE READY =====
$w.onReady(async () => {
    if (!wixUsers.currentUser.loggedIn) {
        safeShow("#textError", "Please log in to register.");
        return;
    }

    ["#group2","#group3","#buttonRegister","#textPlayDown","#PlayDown",
     "#coachRequest","#inputSchoolother","#textError","#textSuccess"]
        .forEach(safeHide);

    $w("#teamParent").onChange(updateVolunteerFields);
    $w("#coachVolunteer").onChange(updateVolunteerFields);
    $w("#inputSchool").onChange(handleSchoolOther);

    try {
        const res = await wixData.query(PLAYER_COLLECTION)
            .eq("reference", wixUsers.currentUser.id)
            .find();

        if (res.items.length === 0) {
            safeShow("#textError", "No players found. Add a player first.");
            return;
        }

        playerDataMap = {};
        $w("#dropdownPlayer").options = res.items.map(p => {
            playerDataMap[p._id] = {
                birthDate: p.playerBirthDate,
                firstName: p.firstName,
                lastName: p.lastName
            };
            return { label: `${p.firstName} ${p.lastName}`, value: p._id };
        });

        safeShow("#group1");
    } catch (e) {
        safeShow("#textError", "Error loading players.");
    }

    $w("#dropdownPlayer").onChange(() => {
        selectedPlayerId = $w("#dropdownPlayer").value;
        playerBirthDate = playerDataMap[selectedPlayerId]?.birthDate;
        calculateDivision();
    });

    $w("#dropdownSport").onChange(calculateDivision);
    $w("#dropdownSeason").onChange(calculateDivision);

    calculateDivision();

        // ===== CLEAR CART + PENDING REGISTRATIONS BUTTON =====
    if ($w('#buttonClearAllRegs')) {
        $w('#buttonClearAllRegs').onClick(async () => {
            console.log('[Reg Page] Clear All button clicked');

            // TODO: Add confirmation modal for better UX
            // Recommended: Create a custom lightbox with "Are you sure?" message
            // For now, we rely on clear button labeling to prevent accidents

            // Disable immediately to prevent double-click spam
            $w('#buttonClearAllRegs').disable();

            try {
                // 1) Clear Wix eCommerce cart via backend
                try {
                    const result = await clearCurrentCart();
                    console.log('[Reg Page] clearCurrentCart result:', result);
                } catch (err) {
                    console.error('[Reg Page] clearCurrentCart threw:', err);
                    // We won't block the rest of the cleanup if this fails
                }

                // 2) Clear the local pending registrations queue
                session.setItem('regQueue', '[]');
                console.log('[Reg Page] regQueue cleared');

                // 3) Optionally clear any status messages
                try {
                    if ($w('#textSuccess')) $w('#textSuccess').hide();
                    if ($w('#textError'))   $w('#textError').hide();
                } catch (e) {
                    console.warn('[Reg Page] Failed to hide status messages:', e);
                }

                // 4) Optional: show a confirmation
                try {
                    if ($w('#textSuccess')) {
                        $w('#textSuccess').text = 'Cart and pending registrations cleared.';
                        $w('#textSuccess').show();
                    }
                } catch (e) {
                    console.warn('[Reg Page] Failed to show success message:', e);
                }

                // NOTE: We *don’t* redirect here so the parent can keep working
                // If you prefer to send them home, uncomment:
                // wixLocation.to('/');

            } finally {
                // Re-enable button (mostly for dev; user may stay on page)
                $w('#buttonClearAllRegs').enable();
            }
        });
    }

});

// ===== REGISTER BUTTON =====
$w("#buttonRegister").onClick(async () => {
    // Disable button immediately to prevent double-click
    const registerButton = $w("#buttonRegister");
    registerButton.disable();

    try {
        if (!isFormValid()) {
            safeShow("#textError", "Please complete all required fields.");
            registerButton.enable(); // Re-enable on validation error
            return;
        }

    const player = playerDataMap[selectedPlayerId];
    const sport = $w("#dropdownSport").value;
    const season = $w("#dropdownSeason").value;

    const divText = $w("#textDivision").text;
    const division = divText.split("→")[1]?.trim() || "Unknown";

    // Capture school dropdown value AND "other" text separately for Airtable
    const schoolDropdown = $w("#inputSchool").value;
    const schoolOther = schoolDropdown === FORM_OPTIONS.SCHOOL_OTHER
        ? $w("#inputSchoolother").value
        : "";
    const school = schoolDropdown === FORM_OPTIONS.SCHOOL_OTHER
        ? $w("#inputSchoolother").value
        : schoolDropdown;

    const registrationItem = {
        playerId: selectedPlayerId,                 // for reference field "player"
        parentId: wixUsers.currentUser.id,          // for reference field "parent"
        playerFirstName: player.firstName,
        playerLastName: player.lastName,
        playerName: `${player.firstName} ${player.lastName}`,
        seasonName: season,
        sport: sport,
        division: division,
        school: school,                             // For Wix DB and display
        schoolOther: schoolOther,                   // For Airtable "School (Other)" field
        jerseySize: $w("#dropdownJerseySize").value,
        emergencyContactName: $w("#inputEmergencyName").value,
        emergencyContactPhone: $w("#inputEmergencyPhone").value,
        inputAdditionalEmail: $w("#inputAdditionalEmail").value || "",
        volunteerInterest: $w("#checkboxVolunteer")?.checked || false,
        requestPlayDown: $w("#PlayDown").value || "",
        coachRequest: $w("#coachRequest").value || "",
        teamParentVolunteer: $w("#teamParent").value || "",
        teamParentName: $w("#inputParentVolunteerName").value || "",
        teamParentEmail: $w("#inputParentVolunteerEmail").value || "",
        teamParentPhone: $w("#inputParentVolunteerPhone").value || "",
        coachVolunteer: $w("#coachVolunteer").value || "",
        coachVolunteerType: $w("#coachVolunteerType").value || "",
        volunteerCoachName: $w("#volunteerCoachName").value || "",
        volunteerCoachEmail: $w("#volunteerCoachEmail").value || "",
        volunteerCoachNumber: $w("#volunteerCoachNumber").value || "",
        // Additional volunteer fields
        inputVolOtherLL: $w("#inputVolOtherLL").value || "",
        volunteerCoachPriorHistory: $w("#volunteerCoachPriorHistory").value || "",
        dropdownVolCrimesMinors: $w("#dropdownVolCrimesMinors").value || "",
        dropdownVolPriorCrime: $w("#dropdownVolPriorCrime").value || "",
        dropdownVolPending: $w("#dropdownVolPending").value || "",
        dropdownVolCriminalCharges: $w("#dropdownVolCriminalCharges").value || "",
        checkboxVolPrivacyPolicy: $w("#checkboxVolPrivacyPolicy")?.checked || false,
        checkboxChildProtectionProgram: $w("#checkboxChildProtectionProgram")?.checked || false,
        checkboxVolunteerApp: $w("#checkboxVolunteerApp")?.checked || false
    };

    // Fee from Airtable
    let fee = 0;
    try {
        const noteRes = await getDivisionNote(division);
        if (noteRes.success) fee = noteRes.fee || 0;
    } catch (e) {
        console.error("[Register] Failed to fetch division fee:", e);
    }

        // Double-check for duplicates before adding to queue
        const duplicateCheck = await checkForDuplicates(
            registrationItem.playerId,
            registrationItem.seasonName,
            registrationItem.sport
        );
        if (duplicateCheck.isDuplicate) {
            safeShow("#textError", duplicateCheck.message);
            registerButton.enable(); // Re-enable on duplicate error
            return;
        }

        // Add to session queue
        let regQueue = JSON.parse(session.getItem("regQueue") || "[]");
        regQueue.push({ ...registrationItem, fee });
        session.setItem("regQueue", JSON.stringify(regQueue));
        console.log("Queue updated:", regQueue);

        // Go to checkout for this registration
        safeShow("#textSuccess", "Success! Taking you to payment...");
        const checkoutUrl = `${ROUTES.CHECKOUT}?player=${encodeURIComponent(registrationItem.playerName)}&sport=${encodeURIComponent(sport)}&division=${encodeURIComponent(division)}&amount=${fee}`;
        setTimeout(() => wixLocation.to(checkoutUrl), DELAYS.FORM_SUBMISSION_REDIRECT);
        // Button stays disabled as we're navigating away

    } catch (error) {
        console.error("[Register Button] Unexpected error:", error);
        safeShow("#textError", "An error occurred. Please try again.");
        registerButton.enable(); // Re-enable on error
    }
});
