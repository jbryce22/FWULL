// FILE: Thank You Page â€“ FINAL CLEAN VERSION
import { session } from 'wix-storage';
import wixData from 'wix-data';
import { syncRegistrationToAirtable } from 'backend/airtable.jsw';
import { AIRTABLE } from 'public/constants.js';

$w.onReady(async () => {
    try {
        const thankYou = $w('#thankYouPage1');
        if (!thankYou || !thankYou.getOrder) {
            console.error("Thank You Page element #thankYouPage1 missing.");
            return;
        }

        // -----------------------------
        // LOAD ORDER DETAILS
        // -----------------------------
        const order = await thankYou.getOrder();
        if (!order) return;

        const orderId = order._id;
        const lineItems = order.lineItems || [];
        console.log("Order:", orderId, lineItems);

        // -----------------------------
        // LOAD regQueue FROM SESSION
        // -----------------------------
        let regQueue = [];
        try {
            regQueue = JSON.parse(session.getItem("regQueue") || "[]");
        } catch (err) {
            console.warn("regQueue parse error:", err);
            regQueue = [];
        }

        if (!regQueue.length) {
            console.warn("No registration queue found.");
            return;
        }

        // -----------------------------
        // BUILD MATCHABLE PRODUCT SLOTS
        // -----------------------------
        const slots = [];
        for (const li of lineItems) {
            const qty = li.quantity || 1;
            for (let i = 0; i < qty; i++) {
                slots.push({ li, used: false });
            }
        }

        // -----------------------------
        // MATCH QUEUED REGISTRATIONS â†’ ORDER LINE ITEMS
        // -----------------------------
        const matched = [];
        for (const reg of regQueue) {
            const idx = slots.findIndex(s =>
                !s.used &&
                typeof s.li.name === "string" &&
                s.li.name.includes(reg.division) // <-- The matching rule
            );

            if (idx !== -1) {
                slots[idx].used = true;
                matched.push({ reg, lineItem: slots[idx].li });
            }
        }

        if (!matched.length) {
            console.warn("No matched registrations.");
            return;
        }

        console.log("Matched registrations:", matched);

        // =============================
        // PROCESS EACH MATCHED REG
        // =============================
        for (const { reg, lineItem } of matched) {

            // Insert to database with initial sync status
            const itemWithSyncStatus = {
                ...itemToInsert,
                airtableSyncStatus: AIRTABLE.SYNC_STATUS.PENDING,
                airtableSyncAttempts: 0
            };
            console.log('[DEBUG] About to insert into CMS:', itemWithSyncStatus);
            const created = await wixData.insert("SeasonRegistration", itemWithSyncStatus);
            console.log('[DEBUG] Inserted SeasonRegistration record:', created);
            console.log("Inserted SeasonRegistration:", created._id);

            // Diagnostic: Check which fields were dropped by Wix
            const sentFields = Object.keys(itemWithSyncStatus);
            const receivedFields = Object.keys(created);
            const droppedFields = sentFields.filter(f => !receivedFields.includes(f) && !f.startsWith('_'));
            if (droppedFields.length > 0) {
                console.error('ðŸš¨ MISSING CMS FIELDS - These fields were sent but not saved:', droppedFields);
                console.error('ðŸ‘‰ Add these fields to your SeasonRegistration CMS collection!');
            }

            // Sync to Airtable with error handling and status tracking
            try {
                // Create clean object for Airtable - exclude Wix system fields and internal tracking fields
                const cleanedForAirtable = {
                    _id: created._id,
                    playerId: created.player,
                    playerBirthDate: reg.playerBirthDate,
                    parentId: created.parent,
                    playerFirstName: created.playerFirstName,
                    playerLastName: created.playerLastName,
                    sport: created.sport,
                    division: created.division,
                    school: created.school,
                    schoolOther: created.schoolOther,
                    jerseySize: created.jerseySize,
                    emergencyContactName: created.emergencyContactName,
                    emergencyContactPhone: created.emergencyContactPhone,
                    inputAdditionalEmail: created.inputAdditionalEmail,
                    requestPlayDown: created.requestPlayDown,
                    coachRequest: created.coachRequest,
                    teamParentVolunteer: created.teamParentVolunteer,
                    teamParentName: created.teamParentName,
                    teamParentEmail: created.teamParentEmail,
                    teamParentPhone: created.teamParentPhone,
                    coachVolunteer: created.coachVolunteer,
                    coachVolunteerType: created.coachVolunteerType,
                    volunteerCoachName: created.volunteerCoachName,
                    volunteerCoachEmail: created.volunteerCoachEmail,
                    volunteerCoachNumber: created.volunteerCoachNumber,
                    // Additional volunteer fields
                    inputVolOtherLL: created.inputVolOtherLL,
                    volunteerCoachPriorHistory: created.volunteerCoachPriorHistory,
                    dropdownVolCrimesMinors: created.dropdownVolCrimesMinors,
                    dropdownVolPriorCrime: created.dropdownVolPriorCrime,
                    dropdownVolPending: created.dropdownVolPending,
                    dropdownVolCriminalCharges: created.dropdownVolCriminalCharges,
                    checkboxVolPrivacyPolicy: created.checkboxVolPrivacyPolicy,
                    checkboxChildProtectionProgram: created.checkboxChildProtectionProgram,
                    checkboxVolunteerApp: created.checkboxVolunteerApp,
                    fee: created.fee,
                    datePaid: created.datePaid
                };

                await syncRegistrationToAirtable(cleanedForAirtable);

                // Update sync status to success
                await wixData.update("SeasonRegistration", {
                    _id: created._id,
                    airtableSyncStatus: AIRTABLE.SYNC_STATUS.SYNCED,
                    airtableSyncedAt: new Date()
                });
                console.log("Airtable sync successful for", created._id);

            } catch (e) {
                console.error("Airtable sync failed for", created._id, e);

                // Update sync status to failed for retry later
                try {
                    await wixData.update("SeasonRegistration", {
                        _id: created._id,
                        airtableSyncStatus: AIRTABLE.SYNC_STATUS.FAILED,
                        airtableSyncError: e.message || String(e),
                        airtableSyncAttempts: 1,
                        lastSyncAttempt: new Date()
                    });
                } catch (updateErr) {
                    console.error("Failed to update sync status for", created._id, updateErr);
                }

                // Continue processing - don't block user flow on Airtable failures
                // Admin can retry failed syncs later via backend job
            }

            const paidAmount = lineItem.totalPrice ??
                ((lineItem.price || 0) * (lineItem.quantity || 1));

            // -----------------------------
            // BUILD CMS ITEM
            // -----------------------------
            const cmsItem = {
                parent: reg.parentId,
                player: reg.playerId,

                playerId: reg.playerId,
                parentId: reg.parentId,
              //  playerFirstName: reg.playerFirstName,
              //  playerLastName: reg.playerLastName,
              //  playerName: reg.playerName,

              //  sport: reg.sport,
            //    division: reg.division,
               // seasonName: reg.seasonName,
              //  jerseySize: reg.jerseySize,

             //   school: reg.school,
             //   schoolOther: reg.schoolOther,

             //   emergencyContactName: reg.emergencyContactName,
             //  emergencyContactPhone: reg.emergencyContactPhone,

              //  inputAdditionalEmail: reg.additionalEmail || "",
              //  requestPlayDown: reg.requestPlayDown || "",
              //  coachRequest: reg.coachRequest || "",

              //  teamParentVolunteer: reg.teamParentVolunteer,
               // teamParentName: reg.teamParentName,
              //  teamParentEmail: reg.teamParentEmail,
               // teamParentPhone: reg.teamParentPhone,

               // coachVolunteer: reg.coachVolunteer,
               // coachVolunteerType: reg.coachVolunteerType,
               // volunteerCoachName: reg.volunteerCoachName,
               // volunteerCoachEmail: reg.volunteerCoachEmail,
               // volunteerCoachNumber: reg.volunteerCoachNumber,

                // Additional volunteer fields only if provided
              //  inputVolOtherLL: reg.inputVolOtherLL || "",
              // volunteerCoachPriorHistory: reg.volunteerCoachPriorHistory || "",
              //  dropdownVolCrimesMinors: reg.dropdownVolCrimesMinors || "",
              //  dropdownVolPriorCrime: reg.dropdownVolPriorCrime || "",
              //  dropdownVolPending: reg.dropdownVolPending || "",

              //  checkboxVolPrivacyPolicy: !!reg.checkboxVolPrivacyPolicy,
              //  checkboxChildProtectionProgram: !!reg.checkboxChildProtectionProgram,
              //  checkboxVolunteerApp: !!reg.checkboxVolunteerApp,

               // fee: paidAmount,
               // paid: true,
               // orderId,
             //   datePaid: new Date(),

              //  airtableSyncStatus: AIRTABLE.SYNC_STATUS.PENDING,
              //  airtableSyncAttempts: 0
            };

            // -----------------------------
            // INSERT INTO CMS
            // -----------------------------
            const inserted = await wixData.insert("SeasonRegistration", cmsItem);
            console.log("Inserted SeasonRegistration:", inserted._id);

            // -----------------------------
            // SYNC TO AIRTABLE
            // -----------------------------
           // try {
           //     const airtablePayload = {
            //        ...reg,
            //        _id: inserted._id,
            //        fee: paidAmount,
             //       datePaid: inserted.datePaid,
             //       playerBirthDate: reg.playerBirthDate
              //  };

             //   const result = await syncRegistrationToAirtable(airtablePayload);

             //   if (result?.success) {
              //      await wixData.update("SeasonRegistration", {
              //          _id: inserted._id,
              //         airtableSyncStatus: AIRTABLE.SYNC_STATUS.SYNCED,
               //         airtableSyncedAt: new Date()
               //     });
               // } else {
               //     throw new Error(result?.error || "Unknown Airtable error");
              // }

            //} catch (err) {
               // console.error("Airtable sync error:", err);

               // await wixData.update("SeasonRegistration", {
               //     _id: inserted._id,
               //     airtableSyncStatus: AIRTABLE.SYNC_STATUS.FAILED,
               //     airtableSyncError: err.message || String(err),
               //     airtableSyncAttempts: 1,
               //     lastSyncAttempt: new Date()
              //  });
            //}
        }

        // -----------------------------
        // REMOVE ONLY PROCESSED ITEMS
        // -----------------------------
        const remaining = regQueue.filter(
            r => !matched.some(m =>
                m.reg.playerId === r.playerId &&
                m.reg.seasonName === r.seasonName &&
                m.reg.sport === r.sport
            )
        );

        session.setItem("regQueue", JSON.stringify(remaining));

    } catch (err) {
        console.error("Error on Thank You Page:", err);
    }
});
