// FILE: Stores Thank You Page code (FIXED VERSION)
import { session } from 'wix-storage';
import wixData from 'wix-data';
import { syncRegistrationToAirtable } from 'backend/airtable';
import { AIRTABLE } from 'public/constants.js';

$w.onReady(async () => {
    try {
        const thankYouEl = $w('#thankYouPage1');
        if (!thankYouEl || !thankYouEl.getOrder) {
            console.error("Thank You Page element #thankYouPage1 not found or missing getOrder().");
            return;
        }

        const order = await thankYouEl.getOrder();
        if (!order) {
            console.warn("No order returned from Thank You Page.");
            return;
        }

        const orderId = order._id;
        const lineItems = order.lineItems || [];
        console.log("Order:", orderId, lineItems);

        // Load queue
        let regQueue = [];
        try {
            regQueue = JSON.parse(session.getItem("regQueue") || "[]");
        } catch (e) {
            console.error("Failed to parse regQueue:", e);
            return;
        }

        if (!Array.isArray(regQueue) || regQueue.length === 0) {
            console.warn("regQueue is empty.");
            return;
        }

        // Build slot array from line items
        const slots = [];
        lineItems.forEach(li => {
            const qty = li.quantity || 1;
            for (let i = 0; i < qty; i++) {
                slots.push({ lineItem: li, used: false });
            }
        });

        const matched = [];

        // Match queue → line items
        for (const reg of regQueue) {
            const idx = slots.findIndex(s =>
                !s.used &&
                typeof s.lineItem.name === "string" &&
                s.lineItem.name.includes(reg.division)
            );
            if (idx !== -1) {
                slots[idx].used = true;
                matched.push({ reg, lineItem: slots[idx].lineItem });
            }
        }

        if (matched.length === 0) {
            console.warn("No registrations matched to order line items.");
            return;
        }

        console.log("Matched registrations:", matched);

        const summaryLines = [];

        // PROCESS EACH MATCHED REGISTRATION
        for (const { reg, lineItem } of matched) {
            console.log("[REG DEBUG] Processing registration:", reg);

            const price =
                (typeof lineItem.totalPrice === "number" ? lineItem.totalPrice : null) ??
                ((lineItem.price || 0) * (lineItem.quantity || 1));

            // Build CMS object
            const itemToInsert = {
                parent: reg.parentId,          
                player: reg.playerId,          
                playerId: reg.playerId,        
                parentId: reg.parentId,        
                playerFirstName: reg.playerFirstName,
                playerLastName: reg.playerLastName,
                playerName: reg.playerName,
                seasonName: reg.seasonName,
                sport: reg.sport,
                division: reg.division,
                school: reg.school,
                schoolOther: reg.schoolOther,
                jerseySize: reg.jerseySize,
                emergencyContactName: reg.emergencyContactName,
                emergencyContactPhone: reg.emergencyContactPhone,
                inputAdditionalEmail: reg.inputAdditionalEmail,
                volunteerInterest: reg.volunteerInterest,

                requestPlayDown: reg.requestPlayDown,
                coachRequest: reg.coachRequest,
                teamParentVolunteer: reg.teamParentVolunteer,
                teamParentName: reg.teamParentName,
                teamParentEmail: reg.teamParentEmail,
                teamParentPhone: reg.teamParentPhone,
                coachVolunteer: reg.coachVolunteer,
                coachVolunteerType: reg.coachVolunteerType,
                volunteerCoachName: reg.volunteerCoachName,
                volunteerCoachEmail: reg.volunteerCoachEmail,
                volunteerCoachNumber: reg.volunteerCoachNumber,

                // Advanced volunteer fields
                inputVolOtherLL: reg.inputVolOtherLL,
                volunteerCoachPriorHistory: reg.volunteerCoachPriorHistory,
                dropdownVolCrimesMinors: reg.dropdownVolCrimesMinors,
                dropdownVolPriorCrime: reg.dropdownVolPriorCrime,
                dropdownVolPending: reg.dropdownVolPending,
                dropdownVolCriminalCharges: reg.dropdownVolCriminalCharges,
                checkboxVolPrivacyPolicy: reg.checkboxVolPrivacyPolicy,
                checkboxChildProtectionProgram: reg.checkboxChildProtectionProgram,
                checkboxVolunteerApp: reg.checkboxVolunteerApp,

                fee: price,
                paid: true,
                orderId: orderId,
                datePaid: new Date(),

                airtableSyncStatus: AIRTABLE.SYNC_STATUS.PENDING,
                airtableSyncAttempts: 0
            };

            // Insert CMS record
            console.log("[CMS] Inserting SeasonRegistration:", itemToInsert);
            const created = await wixData.insert("SeasonRegistration", itemToInsert);
            console.log("[CMS] Inserted record:", created);

            // Airtable SYNC
            try {
                const cleaned = {
                    _id: created._id,
                    playerId: created.player,
                    parentId: created.parent,
                    playerBirthDate: reg.playerBirthDate,
                    ...itemToInsert
                };

                await syncRegistrationToAirtable(cleaned);

                // SUCCESS → Patch only sync fields  
                await wixData.patch("SeasonRegistration", created._id, {
                    airtableSyncStatus: AIRTABLE.SYNC_STATUS.SYNCED,
                    airtableSyncedAt: new Date()
                });

                console.log("[Airtable] Sync successful for", created._id);

            } catch (err) {
                console.error("[Airtable] Sync FAILED for", created._id, err);

                // FAIL → Also patch (not overwrite)
                await wixData.patch("SeasonRegistration", created._id, {
                    airtableSyncStatus: AIRTABLE.SYNC_STATUS.FAILED,
                    airtableSyncError: err.message || String(err),
                    airtableSyncAttempts: 1,
                    lastSyncAttempt: new Date()
                });
            }

            summaryLines.push(`${reg.playerName} – ${reg.division}`);
        }

        // Show confirmation summary
        if ($w("#textRegistrationSummary")) {
            $w("#textRegistrationSummary").text = summaryLines.join("\n");
            $w("#textRegistrationSummary").show();
        }

        // Clean up session queue — remove processed regs
        const remaining = regQueue.filter(r =>
            !matched.some(m =>
                m.reg.playerId === r.playerId &&
                m.reg.seasonName === r.seasonName &&
                m.reg.sport === r.sport
            )
        );
        session.setItem("regQueue", JSON.stringify(remaining));

    } catch (err) {
        console.error("Error on Thank You Page:", err);
    }
});
