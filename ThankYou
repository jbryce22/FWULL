// FILE: Thank You Page â€” FINAL VERSION
import { session } from 'wix-storage';
import wixData from 'wix-data';
import { syncRegistrationToAirtable, syncDonationToAirtable } from 'backend/airtable.jsw';
import { AIRTABLE } from 'public/constants.js';

$w.onReady(async () => {
    try {
        const thankYou = $w('#thankYouPage1');
        if (!thankYou || !thankYou.getOrder) {
            console.error("Thank You Page element #thankYouPage1 missing.");
            return;
        }

        // -----------------------------
        // LOAD ORDER DETAILS
        // -----------------------------
        const order = await thankYou.getOrder();
        console.log("Order Loaded:", order);

        if (!order) return;

        //
        // ðŸ”¥ PROCESS DONATIONS FIRST
        //
        await processDonations(order);

        const orderId = order._id;
        const lineItems = order.lineItems || [];

        // -----------------------------
        // LOAD regQueue
        // -----------------------------
        let regQueue = [];
        try {
            regQueue = JSON.parse(session.getItem("regQueue") || "[]");
        } catch (err) {
            console.warn("regQueue parse error:", err);
            regQueue = [];
        }

        if (!regQueue.length) {
            console.warn("No registration queue found.");
            return;
        }

        // -----------------------------
        // BUILD SLOTS FOR MATCHING
        // -----------------------------
        const slots = [];
        for (const li of lineItems) {
            const qty = li.quantity || 1;
            for (let i = 0; i < qty; i++) {
                slots.push({ li, used: false });
            }
        }

        // -----------------------------
        // MATCH REGISTRATIONS TO LINE ITEMS
        // -----------------------------
        const matched = [];
        for (const reg of regQueue) {
            const idx = slots.findIndex(s =>
                !s.used &&
                typeof s.li.name === "string" &&
                s.li.name.includes(reg.division)
            );

            if (idx !== -1) {
                slots[idx].used = true;
                matched.push({ reg, lineItem: slots[idx].li });
            }
        }

        console.log("Matched Registrations:", matched);

        if (!matched.length) return;

        // -----------------------------
        // INSERT EACH REGISTRATION
        // -----------------------------
        for (const { reg, lineItem } of matched) {

            if (!reg.playerId || !reg.seasonName || !reg.sport) {
                console.error("Skipping invalid registration:", reg);
                continue;
            }

            const paidAmount =
                lineItem.totalPrice ??
                ((lineItem.price || 0) * (lineItem.quantity || 1));

            const cmsItem = {
                parent: reg.parentId,
                player: reg.playerId,

                playerId: reg.playerId,
                parentId: reg.parentId,
                playerFirstName: reg.playerFirstName,
                playerLastName: reg.playerLastName,
                playerName: reg.playerName,

                sport: reg.sport,
                division: reg.division,
                seasonName: reg.seasonName,
                jerseySize: reg.jerseySize,
                school: reg.school,
                schoolOther: reg.schoolOther,

                emergencyContactName: reg.emergencyContactName,
                emergencyContactPhone: reg.emergencyContactPhone,

                inputAdditionalEmail: reg.additionalEmail || "",
                requestPlayDown: reg.requestPlayDown || "",
                coachRequest: reg.coachRequest || "",

                teamParentVolunteer: reg.teamParentVolunteer,
                teamParentName: reg.teamParentName,
                teamParentEmail: reg.teamParentEmail,
                teamParentPhone: reg.teamParentPhone,

                coachVolunteer: reg.coachVolunteer,
                coachVolunteerType: reg.coachVolunteerType,
                volunteerCoachName: reg.volunteerCoachName,
                volunteerCoachEmail: reg.volunteerCoachEmail,
                volunteerCoachNumber: reg.volunteerCoachNumber,

                inputVolOtherLL: reg.inputVolOtherLL || "",
                volunteerCoachPriorHistory: reg.volunteerCoachPriorHistory || "",
                dropdownVolCrimesMinors: reg.dropdownVolCrimesMinors || "",
                dropdownVolPriorCrime: reg.dropdownVolPriorCrime || "",
                dropdownVolPending: reg.dropdownVolPending || "",

                checkboxVolPrivacyPolicy: !!reg.checkboxVolPrivacyPolicy,
                checkboxChildProtectionProgram: !!reg.checkboxChildProtectionProgram,
                checkboxVolunteerApp: !!reg.checkboxVolunteerApp,

                fee: paidAmount,
                paid: true,
                orderId,
                datePaid: new Date()
            };

            const inserted = await wixData.insert("SeasonRegistration", cmsItem);
            console.log("Inserted SeasonRegistration:", inserted._id);

            // Sync to Airtable
            const airtablePayload = {
                ...reg,
                _id: inserted._id,
                fee: paidAmount,
                datePaid: inserted.datePaid,
                playerBirthDate: reg.playerBirthDate
            };

            const result = await syncRegistrationToAirtable(airtablePayload);
            console.log("Registration SYNced â†’ Airtable:", result);
        }

        // -----------------------------
        // CLEANUP SESSION STORE
        // -----------------------------
        const remaining = regQueue.filter(
            r => !matched.some(m =>
                m.reg.playerId === r.playerId &&
                m.reg.seasonName === r.seasonName &&
                m.reg.sport === r.sport
            )
        );

        session.setItem("regQueue", JSON.stringify(remaining));

    } catch (err) {
        console.error("Error on Thank You Page:", err);
    }
});


// ========================================================================
// DONATION LOGIC â€” RUNS FIRST
// ========================================================================

const DONATION_PRODUCTS = {
    "c8faba52-947c-4c0e-ae02-58406cfe5202": 10,
    "80e47dc3-91ee-4b47-ad73-8c17dff81989": 20,
    "ff86a5c7-c653-4f0e-b8b0-3b0fa3b80143": 50,
    "9e1f3628-67c3-467e-bb99-91611426f0dc": 100
};

async function processDonations(order) {
    const lineItems = order.lineItems || [];

    const donorName = `${order.billingInfo?.firstName || ""} ${order.billingInfo?.lastName || ""}`.trim();
    const donorEmail = order.billingInfo?.email || "";

    console.log("Donation Donor:", donorName, donorEmail);

    // Prevent double-processing
    if (session.getItem("donationSynced") === "yes") {
        console.log("Donation already synced â€” skipping duplicate.");
        return;
    }

    for (const li of lineItems) {
        const productId = li.productId;

        if (DONATION_PRODUCTS[productId]) {
            const amount = DONATION_PRODUCTS[productId];

            console.log("FOUND DONATION:", amount);

            const donationRecord = {
            "Your Name": donorName,
            "Donation Amount": amount,
            "Your Email": donorEmail,

            // NEW FIELD â€” Always set for donation-at-registration
            "fldObFdLCIADbG8EN": "Donation at Registration"

            };

            console.log("Sending donation:", donationRecord);

            try {
                const res = await syncDonationToAirtable(donationRecord);
                console.log("Donation SYNced â†’ Airtable:", res);

                // Mark donation as processed
                session.setItem("donationSynced", "yes");

            } catch (err) {
                console.error("Donation Airtable sync failed:", err);
            }
        }
    }
}
